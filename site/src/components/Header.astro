---
// site/src/components/Header.astro
// Ultra Pro Hybrid Navigation: Floating Pill (Desktop) + Immersive Overlay (Mobile)

const base = import.meta.env.BASE_URL;

const navItems = [
  { href: `${base}`, label: 'Accueil', dataAttr: 'data-nav-home' },
  { href: `${base}projects`, label: 'Projets', dataAttr: 'data-nav-work' },
  { href: `${base}blog`, label: 'Blog', dataAttr: 'data-nav-blog' },
];

const currentPath = Astro.url.pathname;
---

<header id="site-header" class="fixed top-0 left-0 right-0 z-50 transition-all duration-500">
  
  <!-- === MOBILE VIEW (Visible < 768px) === -->
  <div class="md:hidden container mx-auto px-4 py-4 flex justify-between items-center relative z-50">
    <!-- Logo Mobile -->
    <a href={base} class="glass-btn-mobile group relative flex items-center justify-center w-10 h-10 rounded-xl overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-br from-[var(--accent-primary)] to-[var(--accent-secondary)] opacity-10 group-hover:opacity-20 transition-opacity"></div>
        <span class="font-bold text-[var(--accent-primary)] text-lg">H</span>
    </a>

    <!-- Hamburger Button -->
    <button id="mobile-menu-trigger" class="glass-btn-mobile w-10 h-10 rounded-xl flex items-center justify-center text-[var(--text-primary)] relative" aria-label="Menu">
        <div class="burger-icon">
            <span></span>
            <span></span>
        </div>
    </button>
  </div>

  <!-- === DESKTOP VIEW (Visible >= 768px) === -->
  <div class="hidden md:block container mx-auto px-6 py-4">
    <div class="relative flex justify-center">
      <!-- Floating Glass Nav Pill -->
      <nav class="glass-nav rounded-full px-2 py-2 flex items-center gap-1 transition-all duration-500 transform hover:scale-[1.01]" id="nav-pill">
        
        <!-- Logo -->
        <a href={base} class="group flex items-center gap-2 px-4 py-2 rounded-full hover:bg-white/5 transition-all duration-300">
          <div class="relative">
            <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-[var(--accent-primary)] to-[var(--accent-secondary)] flex items-center justify-center font-bold text-white text-sm group-hover:scale-110 transition-transform duration-300 shadow-lg shadow-[var(--accent-glow)]">
              H
            </div>
            <div class="absolute inset-0 rounded-xl bg-[var(--accent-primary)] blur-xl opacity-0 group-hover:opacity-50 transition-opacity duration-500"></div>
          </div>
          <span class="font-semibold text-[var(--text-primary)] tracking-tight opacity-90 group-hover:opacity-100">
            Hippolyte de Guign√©
          </span>
        </a>

        <!-- Divider -->
        <div class="w-px h-6 bg-white/10 mx-2"></div>

        <!-- Links -->
        <div class="flex items-center">
          {navItems.map((item) => {
            const isActive = currentPath === item.href || (item.href !== base && currentPath.startsWith(item.href));
            const attrs = { [item.dataAttr]: true };
            return (
              <a href={item.href} class:list={[
                  "relative px-4 py-2 text-sm font-medium rounded-full transition-all duration-300 group",
                  isActive ? "text-[var(--text-primary)] bg-white/10 shadow-inner" : "text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-white/5"
                ]} {...attrs}>
                {item.label}
                {isActive && (
                  <span class="absolute bottom-1.5 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-[var(--accent-primary)] shadow-[0_0_8px_var(--accent-primary)]"></span>
                )}
              </a>
            );
          })}
        </div>

        <!-- Divider -->
        <div class="w-px h-6 bg-white/10 mx-2"></div>

        <!-- Controls (Lang & Theme) -->
        <div class="flex items-center gap-1 px-2 py-1 rounded-full bg-white/5 border border-[var(--glass-border)]">
          <button id="lang-fr" class="lang-btn active px-3 py-1 text-xs font-medium rounded-full transition-all hover:text-white">FR</button>
          <button id="lang-en" class="lang-btn px-3 py-1 text-xs font-medium rounded-full transition-all hover:text-white">EN</button>
        </div>

        <button id="theme-toggle" class="ml-1 w-9 h-9 rounded-full bg-white/5 border border-[var(--glass-border)] hover:bg-white/10 transition-all flex items-center justify-center group" aria-label="Toggle theme">
          <svg id="sun-icon" class="w-4 h-4 text-[var(--text-secondary)] group-hover:text-[var(--accent-primary)] transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
          <svg id="moon-icon" class="w-4 h-4 text-[var(--text-secondary)] group-hover:text-[var(--accent-primary)] transition-colors" style="display: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
          </svg>
        </button>

        <!-- CTA -->
        <a href="mailto:hdg-zero@pm.me" class="ml-2 flex items-center gap-2 px-5 py-2 text-sm font-medium text-white bg-[var(--accent-primary)] rounded-full hover:bg-[var(--accent-primary)]/90 transition-all duration-300 shadow-lg shadow-[var(--accent-glow)] hover:scale-105">
          <span>Email</span>
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
          </svg>
        </a>

      </nav>
    </div>
  </div>

  <!-- === MOBILE OVERLAY MENU (IMMERSIVE) === -->
  <div id="mobile-menu-overlay" class="fixed inset-0 z-40 bg-[var(--bg-primary)]/80 backdrop-blur-2xl opacity-0 pointer-events-none transition-all duration-500 md:hidden flex flex-col justify-center">
    
    <!-- Decorative Gradients inside menu -->
    <div class="absolute top-[-20%] right-[-10%] w-[300px] h-[300px] rounded-full bg-[var(--accent-primary)] blur-[100px] opacity-20"></div>
    <div class="absolute bottom-[-10%] left-[-10%] w-[250px] h-[250px] rounded-full bg-[var(--accent-secondary)] blur-[100px] opacity-20"></div>

    <div class="container mx-auto px-6 relative z-10">
      <nav class="flex flex-col gap-6">
        {navItems.map((item, index) => (
          <a href={item.href} 
             class="mobile-nav-link text-4xl font-bold text-[var(--text-primary)] hover:text-[var(--accent-primary)] transition-colors transform translate-y-4 opacity-0"
             style={`transition-delay: ${index * 100}ms`}>
            {item.label}
          </a>
        ))}
      </nav>

      <div class="w-16 h-1 bg-[var(--glass-border)] rounded-full my-10 opacity-0 mobile-nav-element"></div>

      <div class="flex flex-col gap-6 opacity-0 mobile-nav-element translate-y-4">
        <!-- Mobile Actions Row -->
        <div class="flex items-center justify-between gap-4">
            <!-- Theme Toggle Mobile -->
            <button id="mobile-theme-toggle" class="flex-1 flex items-center justify-center gap-3 px-6 py-4 rounded-2xl bg-white/5 border border-[var(--glass-border)] active:scale-95 transition-all">
                <svg id="mobile-sun-icon" class="w-6 h-6 text-[var(--text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <span id="mobile-theme-text" class="text-[var(--text-secondary)] font-medium">Mode</span>
            </button>

            <!-- Lang Switcher Mobile -->
            <div class="flex-1 flex items-center justify-center gap-1 p-2 rounded-2xl bg-white/5 border border-[var(--glass-border)]">
                <button id="mobile-lang-fr" class="flex-1 py-3 rounded-xl text-sm font-bold text-[var(--text-muted)] transition-all bg-transparent">FR</button>
                <button id="mobile-lang-en" class="flex-1 py-3 rounded-xl text-sm font-bold text-[var(--text-muted)] transition-all bg-transparent">EN</button>
            </div>
        </div>

        <a href="mailto:hdg-zero@pm.me" class="w-full flex items-center justify-center gap-2 px-6 py-4 text-white bg-[var(--accent-primary)] rounded-2xl font-bold shadow-xl shadow-[var(--accent-glow)] active:scale-95 transition-all">
            <span>Envoyer un mail</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
            </svg>
        </a>
      </div>
    </div>
  </div>

</header>

<!-- Spacer -->
<div class="h-20"></div>

<script>
  function initHeader() {
    const header = document.getElementById('site-header');
    const navPill = document.getElementById('nav-pill');
    const mobileBtn = document.getElementById('mobile-menu-trigger');
    const mobileOverlay = document.getElementById('mobile-menu-overlay');
    const mobileLinks = document.querySelectorAll('.mobile-nav-link');
    const mobileElements = document.querySelectorAll('.mobile-nav-element');
    const burgerIcon = document.querySelector('.burger-icon');
    let isMenuOpen = false;

    // --- SCROLL EFFECT ---
    function handleScroll() {
        if (!navPill) return; // Guard for mobile view where navPill might be hidden/absent in DOM logic
        const currentScroll = window.scrollY;
        if (currentScroll > 50) {
            navPill.classList.add('glass-nav-scrolled');
            // header?.classList.add('py-2');
        } else {
            navPill.classList.remove('glass-nav-scrolled');
            // header?.classList.remove('py-2');
        }
    }
    window.addEventListener('scroll', handleScroll, { passive: true });

    // --- MOBILE MENU LOGIC ---
    function toggleMenu() {
        isMenuOpen = !isMenuOpen;
        
        if (isMenuOpen) {
            // Open
            document.body.style.overflow = 'hidden'; // Lock scroll
            mobileOverlay?.classList.remove('opacity-0', 'pointer-events-none');
            mobileOverlay?.classList.add('opacity-100', 'pointer-events-auto');
            burgerIcon?.classList.add('open');
            
            // Stagger animations
            setTimeout(() => {
                mobileLinks.forEach(el => {
                    el.classList.remove('translate-y-4', 'opacity-0');
                });
                mobileElements.forEach(el => {
                    el.classList.remove('translate-y-4', 'opacity-0');
                });
            }, 100);
            
        } else {
            // Close
            document.body.style.overflow = ''; // Unlock scroll
            mobileOverlay?.classList.remove('opacity-100', 'pointer-events-auto');
            mobileOverlay?.classList.add('opacity-0', 'pointer-events-none');
            burgerIcon?.classList.remove('open');
            
            // Reset animations
            mobileLinks.forEach(el => {
                el.classList.add('translate-y-4', 'opacity-0');
            });
            mobileElements.forEach(el => {
                el.classList.add('translate-y-4', 'opacity-0');
            });
        }
    }

    mobileBtn?.addEventListener('click', toggleMenu);

    // Close on link click
    mobileLinks.forEach(link => {
        link.addEventListener('click', () => {
             if(isMenuOpen) toggleMenu();
        });
    });

    // --- THEME & LANG LOGIC (Shared) ---
    // Note: This logic duplicates slightly to ensure both Desktop/Mobile buttons work
    // Ideally this state management should be in a store, but for this file structure:
    
    function updateStateUI() {
        const isDark = document.documentElement.classList.contains('dark');
        const lang = document.documentElement.getAttribute('data-lang') || 'fr';

        // Icons
        const suns = document.querySelectorAll('#sun-icon, #mobile-sun-icon');
        const moons = document.querySelectorAll('#moon-icon'); // You might need a mobile moon icon too
        
        // Simple text toggle for mobile button
        const mobileThemeText = document.getElementById('mobile-theme-text');
        if(mobileThemeText) mobileThemeText.textContent = isDark ? 'Mode clair' : 'Mode sombre';

        // Desktop Icons
        const deskSun = document.getElementById('sun-icon');
        const deskMoon = document.getElementById('moon-icon');
        if (deskSun && deskMoon) {
            deskSun.style.display = isDark ? 'block' : 'none';
            deskMoon.style.display = isDark ? 'none' : 'block';
        }

        // Lang buttons
        document.querySelectorAll('#lang-fr, #mobile-lang-fr').forEach(b => {
            if(lang === 'fr') {
                b.classList.add('active', 'text-white', 'bg-[var(--accent-primary)]');
                b.classList.remove('text-[var(--text-muted)]', 'bg-transparent');
            } else {
                b.classList.remove('active', 'text-white', 'bg-[var(--accent-primary)]');
                b.classList.add('text-[var(--text-muted)]');
            }
        });
        
        document.querySelectorAll('#lang-en, #mobile-lang-en').forEach(b => {
            if(lang === 'en') {
                b.classList.add('active', 'text-white', 'bg-[var(--accent-primary)]');
                b.classList.remove('text-[var(--text-muted)]', 'bg-transparent');
            } else {
                b.classList.remove('active', 'text-white', 'bg-[var(--accent-primary)]');
                b.classList.add('text-[var(--text-muted)]');
            }
        });
    }

    // Attach listeners
    ['theme-toggle', 'mobile-theme-toggle'].forEach(id => {
        document.getElementById(id)?.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            document.documentElement.classList.remove('dark', 'light');
            document.documentElement.classList.add(isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            updateStateUI();
        });
    });

    ['lang-fr', 'mobile-lang-fr'].forEach(id => {
        document.getElementById(id)?.addEventListener('click', () => {
            localStorage.setItem('lang', 'fr');
            document.documentElement.setAttribute('data-lang', 'fr');
            document.documentElement.lang = 'fr';
            updateStateUI();
            window.dispatchEvent(new CustomEvent('languageChange'));
        });
    });

    ['lang-en', 'mobile-lang-en'].forEach(id => {
        document.getElementById(id)?.addEventListener('click', () => {
            localStorage.setItem('lang', 'en');
            document.documentElement.setAttribute('data-lang', 'en');
            document.documentElement.lang = 'en';
            updateStateUI();
            window.dispatchEvent(new CustomEvent('languageChange'));
        });
    });

    // Run once on load
    updateStateUI();
  }

  // Handle Astro View Transitions
  document.addEventListener('astro:page-load', initHeader);
</script>

<style>
  /* === GLASS NAV (DESKTOP) === */
  .glass-nav {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(12px) saturate(180%);
    -webkit-backdrop-filter: blur(12px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 
      0 4px 20px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  /* Scrolled state for desktop nav */
  .glass-nav-scrolled {
    background: rgba(0, 0, 0, 0.7);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.12);
  }

  :global(.light) .glass-nav {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(0, 0, 0, 0.05);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }

  /* === MOBILE BUTTONS === */
  .glass-btn-mobile {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  :global(.light) .glass-btn-mobile {
    background: rgba(0, 0, 0, 0.03);
    border: 1px solid rgba(0, 0, 0, 0.05);
    color: var(--text-primary);
  }

  /* === BURGER ICON ANIMATION === */
  .burger-icon {
    width: 20px;
    height: 14px;
    position: relative;
    transform: rotate(0deg);
    transition: .5s ease-in-out;
  }

  .burger-icon span {
    display: block;
    position: absolute;
    height: 2px;
    width: 100%;
    background: currentColor;
    border-radius: 9px;
    opacity: 1;
    left: 0;
    transform: rotate(0deg);
    transition: .25s ease-in-out;
  }

  .burger-icon span:nth-child(1) { top: 0px; }
  .burger-icon span:nth-child(2) { top: 12px; width: 70%; margin-left: 30%; }

  .burger-icon.open span:nth-child(1) {
    top: 6px;
    transform: rotate(45deg);
  }

  .burger-icon.open span:nth-child(2) {
    width: 100%;
    margin-left: 0;
    top: 6px;
    transform: rotate(-45deg);
  }

  /* === MOBILE NAV ACTIVE STATES === */
  #mobile-lang-fr.active, #mobile-lang-en.active {
      background: var(--accent-primary);
      color: white;
      box-shadow: 0 4px 12px var(--accent-glow);
  }
</style>