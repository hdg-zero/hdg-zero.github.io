---
// site/src/pages/blog/index.astro
// Blog Page with i18n support
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';

const base = import.meta.env.BASE_URL;

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

function formatDate(date: Date) {
	return new Intl.DateTimeFormat('fr-FR', { dateStyle: 'long' }).format(date);
}
---

<BaseLayout title="Blog — Hippolyte de Guigné">
	<div class="container mx-auto px-6 py-20">
		
		<!-- Header -->
		<header class="max-w-3xl mb-20">
			<span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full glass text-xs font-medium text-[var(--accent-primary)] uppercase tracking-widest mb-6 animate-fade-up">
				<span class="w-1.5 h-1.5 rounded-full bg-[var(--accent-primary)]"></span>
				<span data-blog-label>Blog</span>
			</span>
			<h1 class="text-5xl md:text-6xl lg:text-7xl font-bold tracking-tighter mb-6 animate-fade-up delay-100">
				<span data-blog-title>Articles &</span> <span class="text-gradient" data-blog-title-accent>réflexions</span>
			</h1>
			<p class="text-xl text-[var(--text-secondary)] leading-relaxed animate-fade-up delay-200" data-blog-description>
				Plongées profondes dans le développement web, les patterns d'architecture et les leçons apprises.
			</p>
		</header>

		<!-- Posts list -->
		<div class="max-w-3xl space-y-6" id="blog-posts">
			{posts.map((post, index) => (
				<article 
					class="group animate-fade-up blog-post"
					style={`animation-delay: ${200 + index * 100}ms`}
					data-post-lang={post.data.lang || 'fr'}
				>
					<a 
						href={`${base}blog/${post.slug}`}
						class="block glass-card p-6 sm:p-8 rounded-2xl hover:border-[var(--accent-primary)]/30"
					>
						<div class="flex flex-col md:flex-row gap-6">
							<!-- Thumbnail -->
							{post.data.cover && (
								<div class="md:w-48 flex-shrink-0">
									<div class="aspect-video md:aspect-square rounded-xl overflow-hidden bg-[var(--bg-elevated)]">
										<Image 
											src={post.data.cover}
											alt={post.data.coverAlt || ""}
											class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
											width={200}
											height={200}
										/>
									</div>
								</div>
							)}
							
							<!-- Content -->
							<div class="flex-1 flex flex-col justify-center">
								<div class="flex items-center gap-3 text-sm text-[var(--text-muted)] mb-3">
									<time datetime={post.data.publishDate.toISOString()}>
										{formatDate(post.data.publishDate)}
									</time>
									<span class="w-1 h-1 rounded-full bg-[var(--glass-border-hover)]"></span>
									<span>~3 min</span>
								</div>
								
								<h2 class="text-xl sm:text-2xl font-bold text-[var(--text-primary)] group-hover:text-[var(--accent-primary)] transition-colors mb-3">
									{post.data.title}
								</h2>
								
								<p class="text-[var(--text-secondary)] line-clamp-2 mb-4 text-sm sm:text-base">
									{post.data.description}
								</p>
								
								<span class="inline-flex items-center gap-2 text-sm font-medium text-[var(--accent-primary)] group-hover:gap-3 transition-all">
									<span data-blog-read-article>Lire l'article</span>
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
									</svg>
								</span>
							</div>
						</div>
					</a>
				</article>
			))}
		</div>

		<script>
			// Filter blog posts by current language
			function filterBlogPosts() {
				const lang = localStorage.getItem('lang') || 'fr';
				const posts = document.querySelectorAll('.blog-post');
				
				posts.forEach(post => {
					const postLang = post.getAttribute('data-post-lang') || 'fr';
					// Show posts matching current language OR show all if no posts match
					if (postLang === lang) {
						(post as HTMLElement).style.display = '';
					} else {
						(post as HTMLElement).style.display = 'none';
					}
				});
				
				// Check if any posts are visible
				const visiblePosts = document.querySelectorAll('.blog-post[style=""]');
				const emptyState = document.getElementById('blog-empty-state');
				if (visiblePosts.length === 0 && emptyState) {
					emptyState.style.display = 'block';
				} else if (emptyState) {
					emptyState.style.display = 'none';
				}
			}
			
			// Run on page load and language change
			document.addEventListener('astro:page-load', filterBlogPosts);
			window.addEventListener('languageChange', filterBlogPosts);
		</script>

		{posts.length === 0 && (
			<div class="text-center py-20 max-w-md mx-auto">
				<div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl glass mb-6">
					<svg class="w-10 h-10 text-[var(--text-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
					</svg>
				</div>
				<h2 class="text-2xl font-bold text-[var(--text-primary)] mb-3">Aucun article</h2>
				<p class="text-[var(--text-muted)]">Les premiers articles arrivent bientôt !</p>
			</div>
		)}
	</div>
</BaseLayout>
