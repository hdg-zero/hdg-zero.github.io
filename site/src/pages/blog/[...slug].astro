---
// site/src/pages/blog/[...slug].astro
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';

const base = import.meta.env.BASE_URL;

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: { post },
	}));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Get current post language (default to 'fr' if not set)
const currentLang = post.data.lang || 'fr';

function formatDate(date: Date) {
	return new Intl.DateTimeFormat('fr-FR', { dateStyle: 'long' }).format(date);
}

// Get other posts for "Read more" - filter by same language as current post
const allPosts = await getCollection('blog');
const otherPosts = allPosts
	.filter(p => p.slug !== post.slug && (p.data.lang || 'fr') === currentLang)
	.sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
	.slice(0, 2);
---

<BaseLayout title={`${post.data.title} — Blog`} description={post.data.description}>
	<article class="container mx-auto px-6 py-12">
		<!-- Back link -->
		<a 
			href={`${base}blog`}
			class="inline-flex items-center gap-2 text-[var(--text-secondary)] hover:text-[var(--accent-primary)] transition-colors mb-8 group animate-fade-up"
		>
			<svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/>
			</svg>
			<span data-i18n="blog.backToBlog">Retour au blog</span>
		</a>

		<!-- Header -->
		<header class="max-w-3xl mx-auto text-center mb-12">
			<time class="text-[var(--accent-primary)] font-mono text-sm mb-4 block animate-fade-up">
				{formatDate(post.data.publishDate)}
			</time>
			
			<h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6 animate-fade-up delay-100">
				{post.data.title}
			</h1>
			
			<p class="text-xl text-[var(--text-secondary)] leading-relaxed animate-fade-up delay-200">
				{post.data.description}
			</p>
		</header>

		<!-- Cover image -->
		{post.data.cover && (
			<div class="max-w-4xl mx-auto mb-16 animate-fade-up delay-300">
				<div class="relative rounded-2xl overflow-hidden border border-[var(--border-subtle)]">
					<Image 
						src={post.data.cover} 
						alt={post.data.coverAlt || ""} 
						class="w-full h-auto"
						width={1200}
						height={675}
					/>
					<div class="absolute inset-0 bg-gradient-to-t from-[var(--bg-primary)] via-transparent to-transparent opacity-20"></div>
				</div>
			</div>
		)}

		<!-- Content -->
		<div class="max-w-3xl mx-auto">
			<div class="prose prose-lg prose-invert max-w-none
				prose-headings:font-bold prose-headings:text-[var(--text-primary)]
				prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6
				prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-4
				prose-p:text-[var(--text-secondary)] prose-p:leading-relaxed prose-p:mb-6
				prose-a:text-[var(--accent-primary)] prose-a:no-underline hover:prose-a:underline
				prose-strong:text-[var(--text-primary)]
				prose-code:text-[var(--accent-secondary)] prose-code:bg-[var(--bg-elevated)] prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:font-mono
				prose-pre:bg-[var(--bg-secondary)] prose-pre:border prose-pre:border-[var(--border-subtle)] prose-pre:rounded-xl
				prose-blockquote:border-l-[var(--accent-primary)] prose-blockquote:bg-[var(--bg-secondary)] prose-blockquote:py-1 prose-blockquote:px-6 prose-blockquote:rounded-r-xl prose-blockquote:not-italic
				prose-ul:text-[var(--text-secondary)]
				prose-ol:text-[var(--text-secondary)]
				prose-li:marker:text-[var(--accent-primary)]
				prose-img:rounded-xl prose-img:border prose-img:border-[var(--border-subtle)]
			">
				<Content />
			</div>
		</div>

		<!-- Share & actions -->
		<div class="max-w-3xl mx-auto mt-12 pt-8 border-t border-[var(--border-subtle)]">
			<div class="flex flex-wrap items-center justify-between gap-4">
				<div class="flex items-center gap-4">
					<span class="text-[var(--text-muted)] text-sm" data-i18n="blog.share">Partager :</span>
					<a 
						href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.data.title)}&url=${encodeURIComponent(Astro.url.href)}`}
						target="_blank"
						rel="noopener"
						class="p-2 rounded-lg bg-[var(--bg-elevated)] text-[var(--text-secondary)] hover:text-[var(--accent-primary)] hover:bg-[var(--accent-subtle)] transition-colors"
						data-i18n-title="blog.shareTwitter"
						title="Partager sur Twitter"
					>
						<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
							<path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
						</svg>
					</a>
					<a 
						href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`}
						target="_blank"
						rel="noopener"
						class="p-2 rounded-lg bg-[var(--bg-elevated)] text-[var(--text-secondary)] hover:text-[var(--accent-primary)] hover:bg-[var(--accent-subtle)] transition-colors"
						data-i18n-title="blog.shareLinkedin"
						title="Partager sur LinkedIn"
					>
						<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
							<path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
						</svg>
					</a>
				</div>
				
				<a 
					href={`${base}blog`}
					class="text-[var(--text-secondary)] hover:text-[var(--accent-primary)] transition-colors text-sm"
				>
					← <span data-i18n="blog.allArticles">Tous les articles</span>
				</a>
			</div>
		</div>

		<!-- Related posts -->
		{otherPosts.length > 0 && (
			<section class="max-w-3xl mx-auto mt-16 pt-12 border-t border-[var(--border-subtle)]">
				<h2 class="text-2xl font-bold mb-8" data-i18n="blog.alsoRead">À lire également</h2>
				<div class="grid md:grid-cols-2 gap-6">
					{otherPosts.map(related => (
						<a 
							href={`${base}blog/${related.slug}`}
							class="group p-6 rounded-xl border border-[var(--border-subtle)] bg-[var(--bg-secondary)] hover:border-[var(--accent-primary)] transition-all"
						>
							<time class="text-[var(--text-muted)] text-sm">
								{formatDate(related.data.publishDate)}
							</time>
							<h3 class="text-lg font-bold text-[var(--text-primary)] group-hover:text-[var(--accent-primary)] transition-colors mt-2 mb-2">
								{related.data.title}
							</h3>
							<p class="text-sm text-[var(--text-secondary)] line-clamp-2">
								{related.data.description}
							</p>
						</a>
					))}
				</div>
			</section>
		)}
	</article>
</BaseLayout>
